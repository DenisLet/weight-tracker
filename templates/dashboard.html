{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">Dashboard</h2>

<div class="row g-4">
  <!-- Goals -->
  <div class="col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Your Goals</h5>
        <form method="post" action="{{ url_for('settings') }}">
          <div class="mb-3">
            <label class="form-label">Height (cm)</label>
            <input type="number" step="0.1" name="height_cm"
                   class="form-control"
                   value="{{ current_user.height_cm or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Start weight (kg)</label>
            <input type="number" step="0.1" name="start_weight"
                   class="form-control"
                   value="{{ current_user.start_weight or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Target weight (kg)</label>
            <input type="number" step="0.1" name="target_weight"
                   class="form-control"
                   value="{{ current_user.target_weight or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Start date</label>
            <input type="date" name="goal_start" class="form-control"
                   value="{{ current_user.goal_start.isoformat()
                            if current_user.goal_start else '' }}">
          </div>
          <button class="btn btn-success w-100">Save</button>
        </form>

        {% if normal_min and normal_max %}
          {% set ok = current_user.target_weight is not none and
                       normal_min <= current_user.target_weight <= normal_max %}
          <p class="mt-3 small {{ '' if ok else 'text-danger' }}">
            Normal&nbsp;BMI&nbsp;range: {{ normal_min|round(1) }} – {{ normal_max|round(1) }} kg
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Add / Update Entry -->
  <div class="col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Add / Update Entry</h5>
        <form method="post" action="{{ url_for('add_weight') }}">
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" name="day" class="form-control"
                   value="{{ date.today() }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Weight (kg)</label>
            <input type="number" step="0.1" name="kg"
                   class="form-control" required>
          </div>
          <button class="btn btn-primary w-100">Save</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Progress -->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Progress</h5>
        {% if progress is not none %}
          <div class="progress" role="progressbar" aria-valuemin="0"
               aria-valuemax="100" aria-valuenow="{{ progress|round }}">
            <div class="progress-bar progress-bar-striped bg-info"
                 style="width:{{ progress }}%">
              {{ progress|round(1) }}%
            </div>
          </div>
          <p class="mt-2 small">
            From {{ current_user.start_weight }} kg
            to {{ current_user.target_weight }} kg
            {% if days_elapsed is not none %}
              · {{ days_elapsed }} days elapsed
            {% endif %}
          </p>
        {% else %}
          <p class="text-muted">Set start &amp; target weight first.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart -->
<div class="card shadow-sm mt-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="card-title mb-0">Weight trend</h5>
      <div class="d-flex gap-2">
        <select id="chartType" class="form-select form-select-sm w-auto">
          <option value="line"     selected>Line</option>
          <option value="bar">       Bar</option>
          <option value="scatter">   Scatter</option>
          <option value="area">      Area</option>
          <option value="timeline">  Timeline</option>
        </select>
        <button id="resetBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
      </div>
    </div>
    <canvas id="weightChart" height="90"></canvas>
    <p class="small text-muted mt-2 mb-0">
      Zoom: <kbd>Wheel</kbd> / pinch ·&nbsp;Pan: <kbd>Shift</kbd>+Drag
    </p>
  </div>
</div>

<table class="table table-hover mt-4">
  <thead>
    <tr>
      <th>Date</th>
      <th>Weight&nbsp;(kg)</th>
      <th>BMI</th>
      <th>PNL&nbsp;(kg)</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for r in rows %}
    {# цвет строки по знаку PNL #}
    {% set cls = '' %}
    {% if r.pnl is not none %}
      {% if r.pnl < 0 %}{% set cls = 'text-success' %}
      {% elif r.pnl > 0 %}{% set cls = 'text-danger' %}
      {% endif %}
    {% endif %}
    <tr class="{{ cls }}">
      <td>{{ r.day.strftime('%Y-%m-%d') }}</td>
      <td>{{ '%.1f'|format(r.kg) }}</td>

      <td>
        {% if r.bmi is not none %}
          {{ '%.1f'|format(r.bmi) }}
        {% endif %}
      </td>

      <td>
        {% if r.pnl is not none %}
          {{ '%+.1f'|format(r.pnl) }}
        {% endif %}
      </td>

      <td class="text-end">
        {% if r.real %}
          <a class="btn btn-sm btn-outline-secondary"
             href="{{ url_for('edit_weight', weight_id=r.id) }}">Edit</a>
          <a class="btn btn-sm btn-outline-danger"
             href="{{ url_for('delete_weight', weight_id=r.id) }}">×</a>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<!-- Chart.js (у вас уже подключён где-то выше) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<!-- Адаптер дат -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<!-- NEW: плагин zoom/pan -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>

<script>
const labels = {{ labels|tojson }};
const yvals  = {{ data|tojson }};
const points = labels.map((d, i) => ({ x: new Date(d), y: yvals[i] }));

let chart;

/* формируем datasets под нужный режим */
function datasetFor(type){
  if(type === 'timeline'){               // реальная временная шкала
    return [{ label:'Weight (kg)', data:points,
              tension:0.3, borderWidth:2, pointRadius:3 }];
  }
  if(type === 'scatter'){
    return [{ label:'Weight (kg)',
              data:labels.map((d,i)=>({x:d, y:yvals[i]})),
              showLine:false, pointRadius:4 }];
  }
  /* line, bar, area */
  return [{ label:'Weight (kg)', data:yvals,
            fill:(type==='area'), tension:0.3,
            borderWidth:2, pointRadius:3 }];
}

function build(type){
  if(chart) chart.destroy();

  const isTL = (type === 'timeline');
  chart = new Chart(
    document.getElementById('weightChart'),
    {
      type: (type==='area' || isTL) ? 'line' : type,
      data: isTL ? { datasets: datasetFor(type) }
                 : { labels: labels, datasets: datasetFor(type) },
      options:{
        responsive:true,
        plugins:{
          legend:{ display:false },
          zoom:{                                // ← главное
            pan:{
              enabled:true,
              mode:'x',
              modifierKey:'shift'               // Shift+Drag
            },
            zoom:{
              wheel:{ enabled:true },           // колесо
              pinch:{ enabled:true },           // touch-pinch
              mode:'x'
            }
          }
        },
        parsing:(type==='scatter')?false:true,
        scales: isTL
          ? { x:{ type:'time',
                  time:{ unit:'day', tooltipFormat:'yyyy-MM-dd' } } }
          : (type==='scatter' ? { x:{ type:'category' } } : {})
      }
    }
  );
}

/* init + controls */
build('line');
document.getElementById('chartType')
        .addEventListener('change', e=>build(e.target.value));

document.getElementById('resetBtn')
        .addEventListener('click', ()=>chart.resetZoom());
</script>
{% endblock %}